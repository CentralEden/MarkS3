# 要件文書

## 概要

S3上でセルフホスティングされるmarkdown wikiソフトウェアシステム。TypeScript/Svelteを使用したフロントエンドアプリケーションで、milkdownエディタによるmarkdown編集機能、AWS Cognitoによる認証、S3への直接アクセスによるサーバレス構成を実現する。

## 用語集

- **Wiki_System**: S3上でホストされるmarkdown wikiアプリケーション
- **Milkdown_Editor**: markdownの編集に使用するライブラリ
- **Cognito_Auth**: AWS Cognitoによる認証システム
- **S3_Storage**: markdownファイルとメタデータを保存するAWS S3バケット
- **Terraform_Infrastructure**: インフラストラクチャをコードで管理するツール
- **Guest_User**: 認証されていない訪問者（閲覧のみ可能）
- **Regular_User**: 認証済みの一般ユーザー（閲覧とページ編集が可能）
- **Admin_User**: 管理者権限を持つユーザー（閲覧、ページ編集、ユーザー管理が可能）

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、リッチエディタを使用してmarkdownページを作成・編集したい。そうすることで、フォーマットを含むwikiコンテンツを簡単に作成できる。

#### 受け入れ基準

1. ユーザーがページ作成ボタンをクリックしたとき、Wiki_SystemはMilkdown_Editorを空のmarkdownドキュメントと共に表示しなければならない
2. ユーザーがMilkdown_Editorで入力したとき、Wiki_Systemはエディタと並行してリアルタイムmarkdownプレビューを提供しなければならない
3. ユーザーがページを保存したとき、Wiki_Systemは適切なメタデータと共にmarkdownコンテンツをS3_Storageに保存しなければならない
4. Wiki_Systemはヘッダー、リスト、リンク、画像、コードブロックを含む標準的なmarkdown構文をサポートしなければならない
5. ユーザーが既存のページを編集したとき、Wiki_Systemは現在のコンテンツをMilkdown_Editorに読み込まなければならない

### 要件 2

**ユーザーストーリー:** ユーザーとして、AWS Cognitoを使用して認証したい。そうすることで、wikiコンテンツに安全にアクセスし、変更できる。

#### 受け入れ基準

1. Guest_Userがwikiを訪問したとき、Wiki_SystemはCognito_Authによるログインインターフェースを表示しなければならない
2. ユーザーが有効な認証情報を提供したとき、Cognito_Authはユーザーを認証し、アクセストークンとユーザーロール情報を提供しなければならない
3. 認証が成功したとき、Wiki_Systemは認証状態とユーザーロールを保存し、メインwikiインターフェースにリダイレクトしなければならない
4. 認証トークンが期限切れになったとき、Wiki_Systemは自動的にトークンを更新するか、再認証を促さなければならない
5. Wiki_Systemはユーザーロールに基づいて適切な権限を適用しなければならない

### 要件 3

**ユーザーストーリー:** ユーザーとして、wikiページを階層構造で閲覧・検索したい。そうすることで、関連するコンテンツを体系的に整理し、簡単に見つけてナビゲートできる。

#### 受け入れ基準

1. Wiki_Systemは階層構造でwikiページを管理し、フォルダとサブフォルダの概念をサポートしなければならない
2. Wiki_SystemはS3_Storage上でmarkdownファイルを同じ階層構造で保存しなければならない
3. ユーザーがページタイトルをクリックしたとき、Wiki_Systemはそのページコンテンツにナビゲートし、表示しなければならない
4. ユーザーが検索ボックスにテキストを入力したとき、Wiki_Systemはタイトルとコンテンツのマッチングに基づいてページをフィルタリングしなければならない
5. Wiki_Systemは階層構造に対応したパンくずナビゲーションを提供しなければならない
6. Wiki_Systemは作成日と最終更新日を含むページメタデータを表示しなければならない

### 要件 4

**ユーザーストーリー:** ユーザーとして、wikiがバックエンドサーバーなしで動作してほしい。そうすることで、S3とCognitoのみを使用してコスト効率的にデプロイできる。

#### 受け入れ基準

1. Wiki_SystemはS3_Storage上でホストされるクライアントサイドアプリケーションとして完全に動作しなければならない
2. Wiki_Systemはファイル操作のためにAWS SDKを使用してS3_Storageと直接通信しなければならない
3. Wiki_SystemはバックエンドAPIを必要とせずに、すべての認証操作にCognito_Authを使用しなければならない
4. Wiki_Systemはすべてのデータ処理とビジネスロジックをブラウザで処理しなければならない
5. Wiki_Systemは安全なアクセス制御のためにS3バケットポリシーとCognitoアイデンティティプールを使用しなければならない

### 要件 5

**ユーザーストーリー:** 管理者として、ユーザーロールベースのアクセス制御を管理したい。そうすることで、適切な権限でwikiを運用できる。

#### 受け入れ基準

1. Wiki_SystemはGuest_User、Regular_User、Admin_Userの3つのユーザーロールをサポートしなければならない
2. Guest_Userは設定で許可されている場合のみページの閲覧が可能でなければならない
3. Regular_Userはページの閲覧と編集が可能でなければならない
4. Admin_Userはページの閲覧、編集、およびユーザー管理が可能でなければならない
5. ユーザーの追加と削除はAdmin_Userのみが実行可能でなければならない

### 要件 6

**ユーザーストーリー:** 管理者として、ゲストユーザーのアクセス権限を設定ファイルで制御したい。そうすることで、wikiの公開レベルを柔軟に調整できる。

#### 受け入れ基準

1. Wiki_Systemは設定ファイルでGuest_Userの読み取り権限を有効/無効に設定できなければならない
2. ゲストアクセスが無効の場合、Wiki_Systemはすべてのコンテンツアクセスに認証を要求しなければならない
3. ゲストアクセスが有効の場合、Wiki_SystemはGuest_Userにページの閲覧を許可しなければならない
4. Wiki_Systemは設定に関係なく、編集操作をRegular_UserとAdmin_Userのみに制限しなければならない
5. 設定が変更されたとき、Wiki_Systemは再起動なしに新しい設定を適用しなければならない

### 要件 7

**ユーザーストーリー:** ユーザーとして、あらゆる形式のファイルをアップロードし、複数のページから参照したい。そうすることで、リッチなコンテンツを作成し、ファイルを効率的に管理できる。

#### 受け入れ基準

1. Wiki_Systemはファイル形式を問わずあらゆるファイルのアップロードをサポートしなければならない
2. Wiki_Systemは画像ファイル（PNG、JPEG、GIF、SVG、WebP等）をページ上に表示しなければならない
3. Wiki_Systemは画像以外のファイルをダウンロードリンクとして表示しなければならない
4. Wiki_SystemはアップロードされたファイルをS3_Storage上の専用フォルダで管理しなければならない
5. Wiki_Systemは複数のページから同じファイルを参照できる仕組みを提供しなければならない
6. Wiki_Systemはファイルの削除時に参照しているページの一覧を表示し、確認を求めなければならない
7. Wiki_Systemはページ削除時に、そのページにのみ添付されているファイルを検出し、削除確認を求めなければならない
8. Wiki_Systemは他のページから参照されていないファイルのみを孤立ファイルとして扱わなければならない
9. Wiki_Systemはアップロードされたファイルの一覧表示と管理機能を提供しなければならない

### 要件 8

**ユーザーストーリー:** DevOpsエンジニアとして、アプリケーションビルド時に専用のS3バケットとカスタムドメインを設定したい。そうすることで、各wikiインスタンスを独立して管理し、独自のドメインでアクセスできる。

#### 受け入れ基準

1. Wiki_Systemは1つのアプリケーションインスタンスに対して1つの専用S3バケットを使用しなければならない
2. アプリケーションビルド時にユーザーが任意のS3バケット名を指定できなければならない
3. アプリケーションビルド時にユーザーがカスタムドメイン名を指定できなければならない
4. S3バケット名が既に存在する場合、Wiki_Systemは明確なエラーメッセージを表示しなければならない
5. AWS権限が不足している場合、Wiki_Systemは権限不足の詳細なエラーメッセージを表示しなければならない
6. S3バケット作成が成功した場合、Wiki_Systemは作成されたバケット名を確認メッセージとして表示しなければならない
7. 指定されたドメイン名でCloudFrontディストリビューションが自動設定されなければならない

### 要件 9

**ユーザーストーリー:** ユーザーとして、複数人が同じページを同時に編集する際の競合を適切に処理したい。そうすることで、データの整合性を保ちながら協調作業ができる。

#### 受け入れ基準

1. Wiki_Systemは楽観的ロック機能を使用してページの同時編集競合を検出しなければならない
2. 編集競合が発生した場合、Wiki_Systemは競合を検出し、ユーザーに警告を表示しなければならない
3. Wiki_Systemは競合時に現在の内容と他のユーザーの変更内容を比較表示しなければならない
4. Wiki_Systemはユーザーが手動で変更をマージできる機能を提供しなければならない
5. Wiki_Systemはメタデータファイル（pages.json）の更新時も競合を防ぐ仕組みを実装しなければならない

### 要件 10

**ユーザーストーリー:** 開発者として、ソースコードをGitHubで公開管理したい。そうすることで、バージョン管理、協調開発、オープンソースコミュニティへの貢献を実現できる。

#### 受け入れ基準

1. Wiki_Systemのソースコードは全てGitHubリポジトリで管理されなければならない
2. リポジトリには適切な.gitignoreファイルが含まれ、機密情報や一時ファイルが除外されなければならない
3. リポジトリには包括的なREADME.md、ライセンスファイル、コントリビューションガイドが含まれなければならない
4. README.mdには導入方法、設定手順、使用例、トラブルシューティングが詳細に記載されなければならない
5. コミットメッセージは一貫した形式で記述されなければならない
6. リリース時にはGitHubのタグ機能を使用してバージョン管理を行わなければならない
7. 公開リポジトリとして適切なドキュメント構造とコミュニティガイドラインを提供しなければならない

### 要件 11

**ユーザーストーリー:** DevOpsエンジニアとして、Terraformを使用してインフラストラクチャをデプロイしたい。そうすることで、AWSリソースを再現可能でバージョン管理された方法で管理できる。

#### 受け入れ基準

1. Terraform_InfrastructureはS3バケット、Cognitoユーザープール、IAMロールを含むすべての必要なAWSリソースを定義しなければならない
2. Terraform_Infrastructureはブラウザベースのアクセスを許可するためにS3_Storageの適切なCORS設定を構成しなければならない
3. Terraform_InfrastructureはS3アクセスの適切な権限を持つCognitoアイデンティティプールを設定しなければならない
4. Terraform_Infrastructureはユーザーロールに基づくアクセス制御のためのS3バケットポリシーを構成しなければならない
5. Terraform_Infrastructureはフロントエンドアプリケーションに必要な設定値を出力しなければならない