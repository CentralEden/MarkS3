# 設計書

## 概要

この設計は、適切なAWS SDKバンドリング、Node.jsポリフィル、静的ホスティング最適化を実装することで、MarkS3のデプロイメント問題に対処します。ソリューションは、サーバレスアーキテクチャを維持しながら、ブラウザ互換バンドルを生成するようにViteを設定することに焦点を当てています。

## アーキテクチャ

### 現在の問題分析

1. **AWS SDKインポートエラー**: ブラウザがブラウザ環境に存在しないNode.js固有のモジュールを読み込もうとしている
2. **動的インポート失敗**: SvelteKitのコード分割がS3静的ホスティングで動作しないインポートパスを生成している
3. **ポリフィル不足**: AWS SDKが使用するNode.js APIがブラウザ用に適切にポリフィルされていない
4. **静的アセット配信**: S3静的ホスティング設定がJavaScriptモジュールを正しいヘッダーで配信していない可能性

### ソリューションアーキテクチャ

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   ソースコード    │───▶│   Viteバンドラー  │───▶│   静的アセット   │
│                 │    │                  │    │                 │
│ - AWS SDK呼び出し│    │ - ポリフィル注入  │    │ - ブラウザバンドル│
│ - Svelteコンポ   │    │ - コード分割     │    │ - 適切なパス     │
│ - TypeScript    │    │ - ツリーシェイク  │    │ - MIMEタイプ     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │   S3ホスティング  │
                       │                  │
                       │ - 静的ファイル    │
                       │ - フォールバック  │
                       │ - CORSヘッダー   │
                       └──────────────────┘
```

## コンポーネントとインターフェース

### 1. Vite設定の強化

**目的**: AWS SDKとブラウザ互換性のための適切なバンドリング設定

**主な変更点**:
- Node.js API用の強化されたポリフィル設定
- Node.js専用モジュールの適切な外部化
- AWS SDK用の最適化されたチャンク分割
- ブラウザ固有のビルドターゲット

### 2. AWS SDKブラウザ互換性

**目的**: AWS SDKがブラウザ環境で正しく動作することを保証

**実装**:
- ブラウザ固有のAWS SDKインポートを使用
- ブラウザ用の認証情報プロバイダーを設定
- ネットワークリクエストの適切なエラーハンドリングを実装
- 失敗したリクエストのリトライロジックを追加

### 3. 静的ホスティング最適化

**目的**: 最適な静的ホスティングのためのS3とビルドプロセスの設定

**機能**:
- SPA用の適切なフォールバックルーティング
- 最適化されたアセットキャッシュ戦略
- 正しいMIMEタイプ設定
- 効率的なコード分割

### 4. ポリフィル管理

**目的**: ブラウザでのNode.js API互換性を提供

**コンポーネント**:
- バイナリデータ処理用のBufferポリフィル
- AWS SDK互換性用のStreamポリフィル
- 暗号化操作用のCryptoポリフィル
- 環境変数用のProcess/globalポリフィル

## データモデル

### ビルド設定モデル

```typescript
interface BuildConfig {
  target: 'esnext' | 'es2020' | 'es2015';
  polyfills: {
    buffer: boolean;
    stream: boolean;
    crypto: boolean;
    process: boolean;
  };
  chunking: {
    awsSdk: boolean;
    vendor: boolean;
    manual: boolean;
  };
  optimization: {
    treeshaking: boolean;
    minification: boolean;
    compression: boolean;
  };
}
```

### AWS SDK設定モデル

```typescript
interface AWSConfig {
  region: string;
  credentials: {
    type: 'cognito' | 'anonymous';
    identityPoolId?: string;
  };
  services: {
    s3: S3ClientConfig;
    cognito: CognitoClientConfig;
  };
  retry: {
    maxAttempts: number;
    backoff: 'exponential' | 'linear';
  };
}
```

## エラーハンドリング

### モジュール読み込みエラー

1. **検出**: 動的インポート失敗の監視
2. **フォールバック**: 代替読み込み戦略の提供
3. **ユーザーフィードバック**: 意味のあるエラーメッセージの表示
4. **復旧**: リトライメカニズムの実装

### AWS SDKエラー

1. **ネットワーク失敗**: 指数バックオフリトライの実装
2. **認証エラー**: ログインフローへのリダイレクト
3. **権限エラー**: 適切なユーザーメッセージの表示
4. **サービス利用不可**: メンテナンスモードの表示

### ビルドプロセスエラー

1. **ポリフィル失敗**: ポリフィル可用性の検証
2. **バンドルサイズ**: 大きなバンドルの監視と警告
3. **互換性**: ブラウザサポート要件の確認
4. **アセット生成**: すべてのアセットが適切に生成されることの検証

## テスト戦略

### 単体テスト

- ポリフィル機能の検証
- AWS SDKクライアント初期化
- エラーハンドリングメカニズム
- 設定検証

### 統合テスト

- エンドツーエンドAWSサービス通信
- Cognitoでの認証フロー
- S3でのファイル操作
- クロスブラウザ互換性

### ビルドテスト

- バンドルサイズ分析
- アセット生成検証
- ポリフィル包含検証
- 静的ホスティングシミュレーション

### パフォーマンステスト

- 初期読み込み時間測定
- コード分割効果
- ネットワークリクエスト最適化
- キャッシュ戦略検証

## 実装フェーズ

### フェーズ1: Vite設定修正
- ポリフィル設定の更新
- AWS SDKバンドリングの修正
- 適切な外部化の実装
- ローカル開発のテスト

### フェーズ2: AWS SDK最適化
- ブラウザ固有インポートの設定
- 適切なエラーハンドリングの実装
- リトライメカニズムの追加
- 認証フローのテスト

### フェーズ3: 静的ホスティング強化
- ビルド出力の最適化
- 適切なルーティングの設定
- キャッシュ戦略の実装
- デプロイプロセスのテスト

### フェーズ4: パフォーマンス最適化
- バンドルサイズの分析
- コード分割の最適化
- 遅延読み込みの実装
- 本番メトリクスの監視